<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Med Study Sheet Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#007bff">
  <link rel="manifest" href="manifest.webmanifest">
  <!-- Tesseract.js for OCR -->
  <script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    body {
      margin: 0;
      padding: 1rem;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.08);
      padding: 1.5rem 1.75rem 2rem;
      box-sizing: border-box;
    }
    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }
    .subtitle {
      margin-top: 0.25rem;
      font-size: 0.9rem;
      color: #666;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .controls > * {
      font-size: 0.9rem;
    }
    input[type="file"] {
      max-width: 250px;
    }
    select, button {
      padding: 0.35rem 0.6rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fafafa;
      cursor: pointer;
    }
    button {
      border: none;
      background: #007bff;
      color: white;
      font-weight: 500;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      font-size: 0.8rem;
      color: #555;
      min-height: 1em;
      margin-bottom: 0.5rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1fr);
      gap: 1.25rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    /* Page image + overlay */
    .page-wrapper {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.5rem;
      background: #fafafa;
    }
    .page-container {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    #pageImage {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .blank-zone {
      position: absolute;
      background: rgba(255,255,255,0.95);
      border-bottom: 2px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      text-align: center;
      padding: 1px;
      box-sizing: border-box;
      transition: box-shadow 0.15s, border-color 0.15s, background-color 0.15s;
    }
    .blank-zone.hover {
      box-shadow: 0 0 0 2px rgba(0,123,255,0.4);
    }
    .blank-zone.correct {
      border-color: #2e7d32;
      background: rgba(200, 245, 200, 0.95);
    }
    .blank-zone.incorrect {
      border-color: #c62828;
      background: rgba(255, 205, 210, 0.95);
    }

    .hint {
      font-size: 0.78rem;
      color: #777;
      margin-top: 0.35rem;
    }

    /* Sidebar */
    .sidebar {
      border-left: 1px solid #eee;
      padding-left: 1rem;
    }
    @media (max-width: 900px) {
      .sidebar {
        border-left: none;
        border-top: 1px solid #eee;
        padding-left: 0;
        padding-top: 1rem;
      }
    }
    .sidebar h2 {
      font-size: 1rem;
      margin-top: 0;
      margin-bottom: 0.25rem;
    }
    .sidebar p {
      font-size: 0.85rem;
      margin-top: 0;
      color: #555;
    }
    .word-bank {
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 6px;
      background: #fafafa;
      border: 1px solid #eee;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.88rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }
    .badge {
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: #e8f0ff;
      color: #24428a;
      margin-left: 0.3rem;
    }
    .difficulty-label {
      font-weight: 500;
    }
    .small-note {
      font-size: 0.75rem;
      color: #777;
      margin-top: 0.5rem;
    }
    .error {
      color: #b00020;
    }

    .draggable-word {
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #ffffff;
      cursor: grab;
      user-select: none;
      white-space: nowrap;
      font-size: 0.8rem;
    }
    .draggable-word:active {
      cursor: grabbing;
    }

    /* Custom mode panel */
    .custom-panel {
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      border: 1px solid #eee;
      background: #fafafa;
      font-size: 0.85rem;
    }
    .custom-panel h3 {
      margin: 0 0 0.4rem;
      font-size: 0.9rem;
    }
    .custom-list {
      max-height: 180px;
      overflow-y: auto;
      padding: 0.25rem 0;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
      margin-bottom: 0.4rem;
    }
    .custom-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin: 0.1rem 0;
    }
    .custom-item small {
      color: #777;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Med Study Sheet Generator</h1>
    <p class="subtitle">
      Upload your notes, have medical/anatomy/biology terms removed, then drag words/numbers back into place. Custom mode lets you pick exact blanks.
    </p>

    <div class="controls">
      <input type="file" id="imageInput" accept="image/*">
      <label>
        <span class="difficulty-label">Difficulty:</span>
        <select id="difficultySelect">
          <option value="very_easy">Very Easy (few terms)</option>
          <option value="easy">Easy (more terms)</option>
          <option value="medium" selected>Medium (lots of terms + some numbers)</option>
          <option value="hard">Hard (most terms + numbers)</option>
          <option value="insane">Insane (almost everything scientific)</option>
          <option value="custom">Custom (you choose terms)</option>
        </select>
      </label>
      <button id="processBtn" disabled>Generate Study Sheet</button>
    </div>
    <div id="status" class="status"></div>

    <div class="layout">
      <div>
        <div class="page-wrapper">
          <div id="pageContainer" class="page-container">
            <img id="pageImage" alt="Uploaded sheet will appear here">
          </div>
        </div>
        <p class="hint">
          • Drag words from the word bank onto the blanks. Green = correct, red = incorrect.<br>
          • Higher difficulties remove more medical/anatomy/biology terms and numbers. Custom lets you pick exactly which ones.
        </p>

        <div id="customPanel" class="custom-panel" style="display:none;">
          <h3>Custom mode: choose which terms/numbers to remove</h3>
          <p style="margin-top:0;">
            Check the terms you want turned into blanks, then tap <strong>Apply custom blanks</strong>.
          </p>
          <div id="customList" class="custom-list"></div>
          <button id="applyCustomBtn">Apply custom blanks</button>
        </div>
      </div>

      <aside class="sidebar">
        <h2>Word Bank <span id="wordCountBadge" class="badge" style="display:none;"></span></h2>
        <p>Drag each word/number onto the correct blank on the page.</p>
        <div id="wordBank" class="word-bank">
          <em>No sheet processed yet.</em>
        </div>
        <p class="small-note">
          OCR isn’t perfect – it may miss or mis-read some terms. This is a study helper, not a grading system.
        </p>
      </aside>
    </div>
  </div>

  <script>
    // PWA service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').catch(err => {
          console.log('Service worker registration failed:', err);
        });
      });
    }

    const imageInput = document.getElementById('imageInput');
    const processBtn = document.getElementById('processBtn');
    const statusEl = document.getElementById('status');
    const difficultySelect = document.getElementById('difficultySelect');
    const pageImage = document.getElementById('pageImage');
    const pageContainer = document.getElementById('pageContainer');
    const wordBankEl = document.getElementById('wordBank');
    const wordCountBadge = document.getElementById('wordCountBadge');

    const customPanel = document.getElementById('customPanel');
    const customList = document.getElementById('customList');
    const applyCustomBtn = document.getElementById('applyCustomBtn');

    let img = new Image();
    let imgDataUrl = null;
    let customTermMap = null;

    // More aggressive difficulty settings
    const DIFFICULTY_CONFIG = {
      very_easy: { proportion: 0.35, includeNumbers: false },
      easy:      { proportion: 0.55, includeNumbers: false },
      medium:    { proportion: 0.75, includeNumbers: true  },
      hard:      { proportion: 0.9,  includeNumbers: true  },
      insane:    { proportion: 1.0,  includeNumbers: true  }
    };

    const CHANGE_WORDS = new Set([
      "increase","increased","increases","increasing",
      "decrease","decreased","decreases","decreasing",
      "higher","lower","high","low",
      "elevated","elevation",
      "reduced","reduction",
      "upregulated","upregulation","upregulate",
      "downregulated","downregulation","downregulate",
      "more","less","greater","lesser",
      "rise","rises","rising",
      "fall","falls","falling",
      "improve","improves","improved","improvement",
      "worsen","worsens","worsened","worsening"
    ]);

    const MEDICAL_TERMS = new Set([
      // (same as before – anatomy & medical core)
      "artery","arteries","vein","veins","capillary","capillaries","arteriole","venule",
      "heart","atria","atrium","ventricle","ventricles","aorta","pulmonary",
      "cardiac","myocardium","endocardium","pericardium",
      "blood","plasma","erythrocyte","erythrocytes","leukocyte","leukocytes",
      "thrombocyte","thrombocytes","rbc","rbcs","wbc","wbcs","platelet","platelets",
      "hemoglobin","hematocrit",
      "lung","lungs","bronchus","bronchi","bronchiole","bronchioles","alveolus","alveoli",
      "trachea","larynx","pharynx","diaphragm",
      "kidney","kidneys","nephron","nephrons","glomerulus","glomeruli","tubule","tubules",
      "ureter","ureters","urethra","bladder",
      "liver","hepatocyte","hepatocytes","bile","gallbladder",
      "stomach","intestine","intestines","duodenum","jejunum","ileum","colon","rectum","esophagus",
      "pancreas","islet","islets","acinar",
      "brain","cerebrum","cerebellum","brainstem","medulla","pons","midbrain","thalamus","hypothalamus",
      "neuron","neurons","neuroglia","axon","axons","dendrite","dendrites",
      "synapse","synapses","synaptic","neurotransmitter","neurotransmitters",
      "nerve","nerves","spinal","cord","ganglion","ganglia",
      "muscle","muscles","myofiber","myofibers","sarcomere","sarcomeres","myosin","actin",
      "tendon","tendons","ligament","ligaments","fascia",
      "bone","bones","osteon","osteocyte","osteocytes","osteoblast","osteoblasts","osteoclast","osteoclasts","marrow",
      "skull","cranium","vertebra","vertebrae","rib","ribs","sternum","pelvis","femur","tibia","fibula","humerus","radius","ulna","scapula","clavicle",
      "skin","epidermis","dermis","hypodermis","melanocyte","melanocytes","keratinocyte","keratinocytes","sebaceous","sudoriferous",
      "endocrine","hormone","hormones","gland","glands","pituitary","thyroid","parathyroid","adrenal","gonad","gonads","ovary","ovaries","testis","testes",
      "lymph","lymphatic","lymphocyte","lymphocytes","thymus","spleen","node","nodes",
      "immune","immunity","antibody","antibodies","antigen","antigens","phagocyte","phagocytes",
      "macrophage","macrophages","receptor","receptors","afferent","efferent","sensory","motor",
      "systole","diastole","ventilation","perfusion","filtration","reabsorption","secretion",
      "hypertension","hypotension","tachycardia","bradycardia","tachypnea","bradypnea",
      "edema","sepsis","septic","shock","infarction","ischemia","ischemic","necrosis","necrotic",
      "inflammation","inflamed","infected","infection","chronic","acute","subacute",
      "benign","malignant","carcinoma","sarcoma","tumor","neoplasm",
      "failure","insufficiency","obstruction","occlusion","stenosis","regurgitation",
      "metastasis","metastatic",
      "hyperkalemia","hypokalemia","hypernatremia","hyponatremia",
      "hyperglycemia","hypoglycemia","hypercalcemia","hypocalcemia",
      "anemia","anemic","leukocytosis","leukopenia","thrombocytopenia",
      "pneumonia","copd","asthma","emphysema","fibrosis",
      "diabetes","diabetic","nephropathy","retinopathy","neuropathy",
      "cirrhosis","hepatitis","pancreatitis","gastritis","colitis",
      "osteoporosis","arthritis","osteoarthritis","rheumatoid",
      "stroke","cva","tia","myocardial","angina",
      "analgesic","antipyretic","antibiotic","anticoagulant","antiplatelet","antihypertensive",
      "bronchodilator","diuretic","sedative","anesthetic"
    ]);

    // New: broader biology/science vocabulary
    const BIOLOGY_TERMS = new Set([
      "cell","cells","tissue","tissues","organ","organs","organism","organisms",
      "homeostasis","metabolism","metabolic","anabolism","catabolism",
      "protein","proteins","peptide","peptides","amino","aminoacid","aminoacids",
      "enzyme","enzymes","substrate","substrates","product","products",
      "dna","rna","mrna","trna","rrna","chromosome","chromosomes","gene","genes",
      "genome","genetic","heredity","allele","alleles",
      "mitosis","meiosis","replication","transcription","translation",
      "receptor","receptors","ligand","ligands","signal","signaling",
      "diffusion","osmosis","gradient","membrane","membranes","phospholipid","phospholipids",
      "cytoplasm","cytosol","nucleus","nuclei","nucleolus","organelle","organelles",
      "mitochondrion","mitochondria","ribosome","ribosomes","golgi","lysosome","lysosomes","peroxisome","peroxisomes",
      "epithelium","epithelial","connective","connective tissue","smooth","skeletal","cardiac muscle",
      "respiration","aerobic","anaerobic","glycolysis","krebs","citric acid cycle","electron transport",
      "phagocytosis","endocytosis","exocytosis",
      "pathogen","pathogens","bacteria","bacterium","virus","viruses","fungus","fungi","parasite","parasites"
    ]);

    const STEMS = [
      "cardio","neuro","hepat","nephro","pulmon","gastro","derm","dermo",
      "osteo","myo","encephal","angi","phleb","arthr","cranio","hemo","hema","pharm","onc","uro","pneumo",
      "cyto","cyte","hist","myelo","neuro","glia","erythr","leuk","thromb","lymph","oste","chondro","myelin",
      "physio","anatom","bio","immune","endocr","hemat","glyco"
    ];

    const MEDICATION_SUFFIXES = [
      "olol","pril","sartan","dipine","statin","cillin","cycline","mycin","micin",
      "floxacin","azole","prazole","caine","mab","nib","tidine","sone","sonide","solone","dine","dopa","pramide"
    ];

    // New: common pathology/biology suffixes
    const BIO_SUFFIXES = [
      "itis","osis","emia","uria","lysis","lytic","philia","philic","phobic","phobia",
      "plasia","trophy","genic","genesis","oma","opathy","ology","logy"
    ];

    const COMMON_MEDICATIONS = new Set([
      "aspirin","ibuprofen","acetaminophen","paracetamol","naproxen",
      "warfarin","heparin","enoxaparin","apixaban","rivaroxaban",
      "metoprolol","propranolol","atenolol","lisinopril","enalapril","captopril",
      "losartan","valsartan","amlodipine","nifedipine",
      "simvastatin","atorvastatin","rosuvastatin",
      "insulin","metformin","glipizide",
      "albuterol","salbutamol","ipratropium","tiotropium",
      "omeprazole","pantoprazole","lansoprazole",
      "morphine","fentanyl","hydromorphone",
      "vancomycin","ceftriaxone","azithromycin","amoxicillin","ampicillin","clindamycin",
      "gentamicin","tobramycin","doxycycline","ciprofloxacin","levofloxacin",
      "prednisone","dexamethasone","hydrocortisone",
      "diphenhydramine","loratadine","cetirizine"
    ]);

    const STOP_WORDS = new Set([
      "the","and","or","but","a","an","of","in","on","at","to","for","from","with","by","as",
      "is","are","was","were","be","being","been","that","this","those","these","it","its",
      "into","over","under","within","between","through","their","there","then","than"
    ]);

    function normalizeWord(text) {
      return text
        .toLowerCase()
        .replace(/^[^a-z0-9]+|[^a-z0-9]+$/g, "");
    }

    function isNumberWord(text) {
      if (!text) return false;
      const trimmed = text.trim();
      if (!trimmed) return false;
      // digits, /, ., %, +, -, and simple letters like Na, K, Ca
      return /^([0-9][0-9./:%+-]*|[A-Za-z]{1,3}[0-9+\-]*)$/.test(trimmed);
    }

    function isMedicalOrBioWord(text) {
      if (!text) return false;
      const clean = normalizeWord(text);
      if (!clean) return false;

      // Skip common grammar words
      if (STOP_WORDS.has(clean)) return false;

      // Direct sets
      if (CHANGE_WORDS.has(clean)) return true;
      if (MEDICAL_TERMS.has(clean)) return true;
      if (BIOLOGY_TERMS.has(clean)) return true;
      if (COMMON_MEDICATIONS.has(clean)) return true;

      // Prefix stems
      for (const stem of STEMS) {
        if (clean.startsWith(stem) || clean.endsWith(stem)) return true;
      }

      // Medical/biology suffixes
      if (clean.length >= 5) {
        for (const suf of MEDICATION_SUFFIXES) {
          if (clean.endsWith(suf)) return true;
        }
        for (const suf of BIO_SUFFIXES) {
          if (clean.endsWith(suf)) return true;
        }
      }

      // Aggressive fallback: long-ish sciencey-looking words
      if (clean.length >= 8) {
        const vowels = clean.match(/[aeiou]/g) || [];
        const consonants = clean.match(/[^aeiou]/g) || [];
        if (consonants.length >= 4) {
          return true;
        }
      }

      return false;
    }

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || "";
      statusEl.className = "status" + (isError ? " error" : "");
    }

    function clearBlankZones() {
      const existing = pageContainer.querySelectorAll(".blank-zone");
      existing.forEach(el => el.remove());
    }

    function updateWordBank(words) {
      wordBankEl.innerHTML = "";
      wordCountBadge.style.display = "none";

      if (!words || words.length === 0) {
        wordBankEl.innerHTML = "<em>No key terms/numbers were removed (or detected).</em>";
        return;
      }

      const unique = Array.from(new Set(words));
      for (let i = unique.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [unique[i], unique[j]] = [unique[j], unique[i]];
      }

      wordCountBadge.textContent = unique.length + " items";
      wordCountBadge.style.display = "inline-block";

      unique.forEach(w => {
        const tile = document.createElement("div");
        tile.className = "draggable-word";
        tile.draggable = true;
        tile.textContent = w;
        tile.dataset.word = normalizeWord(w);

        tile.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", w);
          tile.classList.add("dragging");
        });
        tile.addEventListener("dragend", () => {
          tile.classList.remove("dragging");
        });

        wordBankEl.appendChild(tile);
      });
    }

    imageInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) {
        processBtn.disabled = true;
        setStatus("");
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => {
        img = new Image();
        img.onload = () => {
          imgDataUrl = ev.target.result;
          pageImage.src = imgDataUrl;
          processBtn.disabled = false;
          clearBlankZones();
          updateWordBank([]);
          customPanel.style.display = "none";
          customTermMap = null;
          setStatus("Image loaded. Choose difficulty, then tap “Generate Study Sheet”.");
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    function createBlanksFromOccurrences(occurrences, removedWords) {
      const rect = pageImage.getBoundingClientRect();
      const scaleX = rect.width / img.naturalWidth;
      const scaleY = rect.height / img.naturalHeight;

      occurrences.forEach((occ, index) => {
        const { text, bbox, normAnswer } = occ;

        const zone = document.createElement("div");
        zone.className = "blank-zone";
        zone.dataset.answer = normAnswer;
        zone.dataset.id = "blank-custom-" + index;

        const padding = 2;
        const x = bbox.x0 * scaleX - padding;
        const y = bbox.y0 * scaleY - padding;
        const w = (bbox.x1 - bbox.x0) * scaleX + padding * 2;
        const h = (bbox.y1 - bbox.y0) * scaleY + padding * 2;

        zone.style.left = x + "px";
        zone.style.top = y + "px";
        zone.style.width = w + "px";
        zone.style.height = h + "px";

        zone.addEventListener("dragover", e => {
          e.preventDefault();
          zone.classList.add("hover");
        });
        zone.addEventListener("dragleave", () => {
          zone.classList.remove("hover");
        });
        zone.addEventListener("drop", e => {
          e.preventDefault();
          zone.classList.remove("hover");
          const droppedText = e.dataTransfer.getData("text/plain") || "";
          const droppedNorm = normalizeWord(droppedText);
          const correct = droppedNorm && droppedNorm === zone.dataset.answer;
          zone.textContent = droppedText;
          zone.classList.remove("correct", "incorrect");
          zone.classList.add(correct ? "correct" : "incorrect");
        });

        pageContainer.appendChild(zone);
        removedWords.push(text);
      });
    }

    applyCustomBtn.addEventListener("click", () => {
      if (!customTermMap) {
        setStatus("No custom terms available. Run Generate Study Sheet in Custom mode first.", true);
        return;
      }
      clearBlankZones();
      const checked = Array.from(customList.querySelectorAll("input[name='customTerm']:checked"));
      if (checked.length === 0) {
        setStatus("No terms selected. Check at least one term to turn into blanks.", true);
        return;
      }

      const removedWords = [];
      checked.forEach(input => {
        const key = input.value;
        const termData = customTermMap.get(key);
        if (!termData) return;
        const occurrences = termData.occurrences.map(occ => ({
          text: termData.display,
          bbox: occ.bbox,
          normAnswer: key
        }));
        createBlanksFromOccurrences(occurrences, removedWords);
      });

      updateWordBank(removedWords);
      setStatus(`Custom blanks created for ${checked.length} selected term(s). Drag words onto the blanks.`);
    });

    processBtn.addEventListener("click", async () => {
      if (!imgDataUrl) return;

      setStatus("Running OCR and selecting medical/anatomy/biology words…");
      processBtn.disabled = true;
      clearBlankZones();
      updateWordBank([]);
      customPanel.style.display = "none";
      customTermMap = null;

      try {
        await new Promise(resolve => {
          if (pageImage.complete) resolve();
          else pageImage.onload = () => resolve();
        });

        const result = await Tesseract.recognize(img, "eng", { logger: () => {} });
        const words = result.data.words || [];

        const medicalCandidates = [];
        const numberCandidates = [];

        words.forEach(w => {
          const rawText = w.text || "";
          if (!rawText.trim()) return;

          if (isMedicalOrBioWord(rawText)) {
            const { x0, y0, x1, y1 } = w.bbox;
            medicalCandidates.push({ text: rawText, bbox: { x0, y0, x1, y1 } });
          } else if (isNumberWord(rawText)) {
            const { x0, y0, x1, y1 } = w.bbox;
            numberCandidates.push({ text: rawText, bbox: { x0, y0, x1, y1 } });
          }
        });

        if (medicalCandidates.length === 0 && numberCandidates.length === 0) {
          setStatus("No medical/anatomy/biology terms or numbers were confidently detected.", true);
          updateWordBank([]);
          processBtn.disabled = false;
          return;
        }

        const diffKey = difficultySelect.value || "medium";

        if (diffKey === "custom") {
          // Build term map for custom selection
          const termMap = new Map();

          const addToMap = (candidate, isNumber) => {
            const norm = normalizeWord(candidate.text);
            const key = norm || candidate.text.trim();
            if (!key) return;
            if (!termMap.has(key)) {
              termMap.set(key, {
                display: candidate.text,
                isNumber,
                occurrences: []
              });
            }
            termMap.get(key).occurrences.push({ bbox: candidate.bbox });
          };

          medicalCandidates.forEach(c => addToMap(c, false));
          numberCandidates.forEach(c => addToMap(c, true));

          if (termMap.size === 0) {
            setStatus("No usable terms found for custom mode.", true);
            processBtn.disabled = false;
            return;
          }

          customList.innerHTML = "";
          termMap.forEach((value, key) => {
            const row = document.createElement("div");
            row.className = "custom-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "customTerm";
            checkbox.value = key;

            const label = document.createElement("label");
            label.textContent = value.display;

            const meta = document.createElement("small");
            meta.textContent = value.isNumber ? "number" : "term";

            row.appendChild(checkbox);
            row.appendChild(label);
            row.appendChild(meta);

            customList.appendChild(row);
          });

          customTermMap = termMap;
          customPanel.style.display = "block";
          setStatus("Custom mode: select which terms/numbers to remove, then tap “Apply custom blanks”.");
          processBtn.disabled = false;
          return;
        }

        // Non-custom modes
        const config = DIFFICULTY_CONFIG[diffKey] || DIFFICULTY_CONFIG.medium;
        let allCandidates = medicalCandidates.slice();
        if (config.includeNumbers) {
          allCandidates = allCandidates.concat(numberCandidates);
        }

        if (allCandidates.length === 0) {
          setStatus("No candidates found for this difficulty (try a different image).", true);
          processBtn.disabled = false;
          return;
        }

        const proportion = config.proportion;
        const totalToHide = Math.max(1, Math.round(allCandidates.length * proportion));

        const shuffled = allCandidates.slice();
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        const toHide = shuffled.slice(0, totalToHide);

        const rect = pageImage.getBoundingClientRect();
        const scaleX = rect.width / img.naturalWidth;
        const scaleY = rect.height / img.naturalHeight;

        const removedWords = [];

        toHide.forEach(({ text, bbox }, index) => {
          const norm = normalizeWord(text) || text.trim();

          const zone = document.createElement("div");
          zone.className = "blank-zone";
          zone.dataset.answer = norm;
          zone.dataset.id = "blank-" + index;

          const padding = 2;
          const x = bbox.x0 * scaleX - padding;
          const y = bbox.y0 * scaleY - padding;
          const w = (bbox.x1 - bbox.x0) * scaleX + padding * 2;
          const h = (bbox.y1 - bbox.y0) * scaleY + padding * 2;

          zone.style.left = x + "px";
          zone.style.top = y + "px";
          zone.style.width = w + "px";
          zone.style.height = h + "px";

          zone.addEventListener("dragover", e => {
            e.preventDefault();
            zone.classList.add("hover");
          });
          zone.addEventListener("dragleave", () => {
            zone.classList.remove("hover");
          });
          zone.addEventListener("drop", e => {
            e.preventDefault();
            zone.classList.remove("hover");
            const droppedText = e.dataTransfer.getData("text/plain") || "";
            const droppedNorm = normalizeWord(droppedText) || droppedText.trim();
            const correct = droppedNorm && droppedNorm === zone.dataset.answer;
            zone.textContent = droppedText;
            zone.classList.remove("correct", "incorrect");
            zone.classList.add(correct ? "correct" : "incorrect");
          });

          pageContainer.appendChild(zone);
          removedWords.push(text);
        });

        updateWordBank(removedWords);
        setStatus(`Done! Created ${toHide.length} blanks at ${diffKey.replace('_',' ')} difficulty.`);
      } catch (err) {
        console.error(err);
        setStatus("Something went wrong while processing the image. Try a clearer image, or refresh the page.", true);
      } finally {
        processBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
